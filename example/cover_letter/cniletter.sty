%%
%% This is file `cniletter.sty',
%%
%% providing a LaTeX class for writing a letter with Columbia Nano Initiative
%% letterhead.
%% ------------------------------------------------------------------------------
%% Copyright (C) 2023 Yuyang Wang <yw3831@columbia.edu>
%% 
%% License CC-BY-SA 4.0
%% This work is licensed under a Creative Commons Attribution-ShareAlike 4.0
%% International License (https://creativecommons.org/licenses/by-sa/4.0/).
%% ------------------------------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cniletter}[2023/02/20 v0.1]
\RequirePackage{fontspec} % for font selection
\RequirePackage{xcolor} % for color selection
\RequirePackage{geometry} % for page layout
\RequirePackage{fancyhdr} % for header and footer
\RequirePackage{lastpage} % for page number
\RequirePackage{ifthen} % for conditional statements
\RequirePackage{graphicx}
\RequirePackage{ragged2e} % for ragged right

%% Geometry
\geometry{
    letterpaper,
    left=1in,
    right=1in,
    top=1in,
    bottom=1in,
    headsep=2\baselineskip
}

%% Font selection
\newfontfamily{\cuLogoFont}{TrajanPro}[
    Path = ./font/,
    Extension = .ttf,
    UprightFont = *-Regular,
    BoldFont = *-Bold
]
\newfontfamily{\cuTextFont}{EBGaramond}[
    Path = ./font/,
    Extension = .ttf,
    UprightFont = *-Regular,
    BoldFont = *-Bold,
    ItalicFont = *-Italic,
    BoldItalicFont = *-BoldItalic
]
\setmainfont{Times New Roman}

%% Color selection
\definecolor{cuPrimaryColor}{HTML}{000D74}

% Header and footer styling
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[C]{\ifnum\thepage=1 {\cuLogoFont\textcolor{cuPrimaryColor}{
            {\LARGE \textbf{Columbia University}}\\
            \smallskip
            IN THE CITY OF NEW YORK
        }}\\
        \bigskip
        {\cuTextFont\textcolor{cuPrimaryColor}{
                {\large COLUMBIA NANO INITIATIVE}
            }}
    \else \fi}
\fancyfoot[C]{\cuTextFont\textcolor{cuPrimaryColor}{%
        {\small 530 West 120\textsuperscript{th} Street \quad CEPSR Suite 1001 \quad Mail Code 8903 \quad New York, NY 10027\\
                Tel 212-854-3265 \quad Fax 212-854-1909}
    }
}
\let\ps@firstpage\ps@fancy

%% Signature file
\def\insertSignature{}
\newcommand*\signatureFile[2][height=0.05\paperheight]{
    \ifx#2\@empty\else%
        \edef\insertSignature{\includegraphics[#1]{#2}}%
    \fi%
}

%% Regarding line
\def\insertRegard{}
\newcommand*\regard[1]{
    \ifx#1\@empty\else%
        \edef\insertRegard{Re: \underline{#1}}%
    \fi%
}

\renewcommand*\ps{\par\startbreaks P.S.~}

\DeclareOption{toAddrRight}{% this is the LaTeX letter class default
    \renewcommand*{\opening}[1]{\vspace*{3\baselineskip}%
        \ifx\@empty\fromaddress
            \thispagestyle{fancy}%
            {\raggedleft\@date\par}%
        \else  % home address
            \thispagestyle{fancy}%
            {\raggedleft\begin{tabular}{l@{}}\ignorespaces
                    \fromaddress \\*[2\parskip]%
                    \@date\end{tabular}\par}%
        \fi
        \vspace{2\parskip}%
        {\raggedright \toname \\ \toaddress \par}%
        \vspace{2\parskip}%
        #1\par\nobreak
        \raggedright
        \ifx\insertRegard\@empty\else%
            \insertRegard \par%
        \fi}
}
\DeclareOption{toAddrLeft}{% this is the cniletter class default
    \renewcommand*{\opening}[1]{\vspace*{3\baselineskip}%
        \ifx\@empty\fromaddress
            \thispagestyle{fancy}%
            {\raggedright\@date\par}%
        \else  % home address
            \thispagestyle{fancy}%
            {\raggedright\begin{tabular}{@{}l}\ignorespaces
                    \fromaddress \\*[2\parskip]%
                    \@date\end{tabular}\par}%
        \fi
        \vspace{2\parskip}%
        {\raggedright \toname \\ \toaddress \par}%
        \vspace{2\parskip}%
        #1\par\nobreak
        \raggedright
        \ifx\insertRegard\@empty\else%
            \insertRegard \par%
        \fi}
}
\DeclareOption{sigRight}{% this is the LaTeX letter class default
    \renewcommand*{\closing}[1]{\justifying%
        \par\nobreak\vspace{\parskip}%
        \stopbreaks
        \noindent
        \ifx\@empty\fromaddress\else
            \hspace*{\longindentation}\fi
        \parbox{\linewidth}{\raggedright
            \ignorespaces #1\\
            \ifx\insertSignature\@empty[6\medskipamount]%
            \else\bigskip\insertSignature\smallskip\\%
            \fi
            \ifx\@empty\fromsig
                \fromname
            \else \fromsig \fi\strut}%
        \par}
}
\DeclareOption{sigLeft}{% this is the cniletter class default
    \renewcommand*{\closing}[1]{\justifying%
        \par\nobreak\vspace{\parskip}%
        \stopbreaks
        \noindent
        \parbox{\linewidth}{\raggedright
            \ignorespaces #1\\
            \ifx\insertSignature\@empty[6\medskipamount]%
            \else\bigskip\insertSignature\smallskip\\%
            \fi
            \ifx\@empty\fromsig
                \fromname
            \else \fromsig \fi\strut}%
        \par}
}
\ExecuteOptions{toAddrLeft,sigLeft}
\ProcessOptions